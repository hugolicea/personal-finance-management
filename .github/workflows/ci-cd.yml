name: CI/CD Pipeline

on:
    push:
        branches: [main, dev, develop]
    pull_request:
        branches: [main]

# Cancel in-progress runs when a new run is triggered
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    test-backend:
        runs-on: ubuntu-latest
        timeout-minutes: 10 # GitHub best practice: most test suites < 10min

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_DB: test_db
                    POSTGRES_USER: test_user
                    POSTGRES_PASSWORD: test_password
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Install dependencies
              working-directory: ./backend
              run: |
                  pip install -r requirements.txt
                  pip install -r requirements.dev.txt

            - name: Run linting
              working-directory: ./backend
              run: |
                  ruff check . --config ../ruff.toml
                  ruff format --check . --config ../ruff.toml

            - name: Run tests
              working-directory: ./backend
              env:
                  DJANGO_SETTINGS_MODULE: personal_finance_management.settings
                  SECRET_KEY: test-secret-key
                  DEBUG: True
                  DB_NAME: test_db
                  DB_USER: test_user
                  DB_PASSWORD: test_password
                  DB_HOST: localhost
                  DB_PORT: 5432
              run: |
                  mkdir -p logs
                  pytest --cov=budget --cov-report=xml --cov-report=term

            - name: Upload coverage
              uses: codecov/codecov-action@v3
              with:
                  file: ./backend/coverage.xml
                  flags: backend

    test-frontend:
        runs-on: ubuntu-latest
        timeout-minutes: 8 # GitHub best practice: Node.js builds typically 5-8min

        steps:
            - uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20' # Updated to Node 20 (LTS)
                  cache: 'npm'
                  cache-dependency-path: ./frontend/package-lock.json

            - name: Install dependencies
              working-directory: ./frontend
              run: npm ci

            - name: Run linting
              working-directory: ./frontend
              run: |
                  npm run lint || echo "Linting completed with warnings"
              continue-on-error: true # Don't fail on lint warnings

            - name: Type check
              working-directory: ./frontend
              run: npx tsc --noEmit

            - name: Build
              working-directory: ./frontend
              run: npm run build

    security-scan:
        runs-on: ubuntu-latest
        timeout-minutes: 10
        permissions:
            contents: read
            actions: read # Required for workflow run telemetry
            security-events: write # Required for uploading SARIF

        steps:
            - uses: actions/checkout@v3

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: 'fs'
                  scan-ref: '.'
                  format: 'sarif'
                  output: 'trivy-results.sarif'
              continue-on-error: true # Don't fail if vulnerabilities found

            - name: Upload Trivy results to GitHub Security
              uses: github/codeql-action/upload-sarif@v4
              with:
                  sarif_file: 'trivy-results.sarif'
              if: always() # Upload even if scan fails
